<!doctype html>
<html amp="" lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1">
	
<meta property="og:type" content="article">
<meta property="og:title" content="Three Rings for the Z80">
<meta property="og:url" content="https://feilipu.me/2018/05/28/three-rings-for-the-z80/">
<meta property="og:description" content="Over the past few years I&#8217;ve implemented a number of interfaces for Z80 peripherals based on the principal of the interrupt driven ring buffer. Each implementation of a ring exhibits its own …">
<meta property="article:published_time" content="2018-05-28T11:13:02+00:00">
<meta property="article:modified_time" content="2018-08-08T12:33:22+00:00">
<meta property="og:site_name" content="feilipu">
<meta property="og:image" content="https://feilipu.files.wordpress.com/2018/05/unico_anello.png">
<meta property="og:image:width" content="2240">
<meta property="og:image:height" content="1939">
<meta property="og:locale" content="en_US">
<meta name="twitter:site" content="@wordpressdotcom">
<meta name="twitter:text:title" content="Three Rings for the Z80">
<meta name="twitter:card" content="summary">
<meta property="article:publisher" content="https://www.facebook.com/WordPresscom">

	<title>Three Rings for the Z80 &#8211; feilipu</title>
		<link rel="canonical" href="..\index.html">
	<script type='text/javascript' src='https://cdn.ampproject.org/v0.js' async=""></script>
<script type='text/javascript' src='https://cdn.ampproject.org/v0/amp-anim-0.1.js' async="" custom-element="amp-anim"></script>
<script type='text/javascript' src='https://cdn.ampproject.org/v0/amp-social-share-0.1.js' async="" custom-element="amp-social-share"></script>
<style amp-boilerplate="">body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate="">body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>	<script type="application/ld+json">{"@context":"http:\/\/schema.org","publisher":{"@type":"Organization","name":"feilipu","logo":"https:\/\/s2.wp.com\/wp-content\/plugins\/amp-1.4\/assets\/images\/amp-page-fallback-wordpress-publisher-logo.png"},"@type":"BlogPosting","mainEntityOfPage":"https:\/\/feilipu.me\/2018\/05\/28\/three-rings-for-the-z80\/","headline":"Three Rings for the Z80","datePublished":"2018-05-28T11:13:02+10:00","dateModified":"2018-08-08T12:33:22+10:00","author":{"@type":"Person","name":"feilipu"},"image":"https:\/\/feilipu.files.wordpress.com\/2018\/05\/unico_anello.png"}</script>
	<meta name="generator" content="AMP Plugin v1.4.2; mode=reader; experiences=website"><meta name="generator" content="WordPress.com">
	<style amp-custom="">
		/* Generic WP styling */

.alignright {
	float: right;
}

.alignleft {
	float: left;
}

.aligncenter {
	display: block;
	text-align: center;
	margin-left: auto;
	margin-right: auto;
}

.amp-wp-enforced-sizes {
	/** Our sizes fallback is 100vw, and we have a padding on the container; the max-width here prevents the element from overflowing. **/
	max-width: 100%;
	margin: 0 auto;
}


/*
 * Prevent cases of amp-img converted from img to appear with stretching by using object-fit to scale.
 * See <https://github.com/ampproject/amphtml/issues/21371#issuecomment-475443219>.
 * Also use object-fit:contain in worst case scenario when we can't figure out dimensions for an image.
 * Additionally, in side of \AMP_Img_Sanitizer::determine_dimensions() it could $amp_img->setAttribute( 'object-fit', 'contain' )
 * so that the following rules wouldn't be needed.
 */
amp-img.amp-wp-enforced-sizes[layout="intrinsic"] > img,
amp-anim.amp-wp-enforced-sizes[layout="intrinsic"] > img {
	object-fit: contain;
}

amp-fit-text blockquote,
amp-fit-text h1,
amp-fit-text h2,
amp-fit-text h3,
amp-fit-text h4,
amp-fit-text h5,
amp-fit-text h6 {
	font-size: inherit;
}

/**
 * Override a style rule in Twenty Sixteen and Twenty Seventeen.
 * It set display:none for audio elements.
 * This selector is the same, though it adds body and uses amp-audio instead of audio.
 */
body amp-audio:not([controls]) {
	display: inline-block;
	height: auto;
}

/*
 * Style the default template messages for submit-success, submit-error, and submitting. These elements are inserted
 * by the form sanitizer when a POST form lacks the action-xhr attribute.
 */
.amp-wp-default-form-message > p {
	margin: 1em 0;
	padding: 0.5em;
}

.amp-wp-default-form-message[submitting] > p,
.amp-wp-default-form-message[submit-success] > p.amp-wp-form-redirecting {
	font-style: italic;
}

.amp-wp-default-form-message[submit-success] > p:not(.amp-wp-form-redirecting) {
	border: solid 1px #008000;
	background-color: #90ee90;
	color: #000;
}

.amp-wp-default-form-message[submit-error] > p {
	border: solid 1px #f00;
	background-color: #ffb6c1;
	color: #000;
}

/* Prevent showing empty success message in the case of an AMP-Redirect-To response header. */
.amp-wp-default-form-message[submit-success] > p:empty {
	display: none;
}

amp-carousel .amp-wp-gallery-caption {
	position: absolute;
	bottom: 0;
	left: 0;
	right: 0;
	text-align: center;
	background-color: rgba(0, 0, 0, 0.5);
	color: #fff;
	padding: 1rem;
}

.wp-block-gallery[data-amp-carousel="true"] {
	display: block;
	flex-wrap: unset;
}

/* Template Styles */

.amp-wp-content,
.amp-wp-title-bar div {
		margin: 0 auto;
	max-width: 630px;
	}

html {
	background: #0a89c0;
}

body {
	background: #fff;
	color: #353535;
	font-family: Georgia, 'Times New Roman', Times, Serif;
	font-weight: 300;
	line-height: 1.75em;
}

p,
ol,
ul,
figure {
	margin: 0 0 1em;
	padding: 0;
}

a,
a:visited {
	color: #0a89c0;
}

a:hover,
a:active,
a:focus {
	color: #353535;
}

/* Quotes */

blockquote {
	color: #353535;
	background: rgba(127,127,127,.125);
	border-left: 2px solid #0a89c0;
	margin: 8px 0 24px 0;
	padding: 16px;
}

blockquote p:last-child {
	margin-bottom: 0;
}

/* UI Fonts */

.amp-wp-meta,
.amp-wp-header div,
.amp-wp-title,
.wp-caption-text,
.amp-wp-tax-category,
.amp-wp-tax-tag,
.amp-wp-comments-link,
.amp-wp-footer p,
.back-to-top {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen-Sans", "Ubuntu", "Cantarell", "Helvetica Neue", sans-serif;
}

/* Header */

.amp-wp-header {
	background-color: #0a89c0;
}

.amp-wp-header div {
	color: #fff;
	font-size: 1em;
	font-weight: 400;
	margin: 0 auto;
	max-width: calc(840px - 32px);
	padding: .875em 16px;
	position: relative;
}

.amp-wp-header a {
	color: #fff;
	text-decoration: none;
}


.amp-wp-header .amp-wp-site-icon {
	/** site icon is 32px **/
	background-color: #fff;
	border: 1px solid #fff;
	border-radius: 50%;
	position: absolute;
	right: 18px;
	top: 10px;
}

/* Article */

.amp-wp-article {
	color: #353535;
	font-weight: 400;
	margin: 1.5em auto;
	max-width: 840px;
	overflow-wrap: break-word;
	word-wrap: break-word;
}

/* Article Header */

.amp-wp-article-header {
	align-items: center;
	align-content: stretch;
	display: flex;
	flex-wrap: wrap;
	justify-content: space-between;
	margin: 1.5em 16px 0;
}

.amp-wp-title {
	color: #353535;
	display: block;
	flex: 1 0 100%;
	font-weight: 900;
	margin: 0 0 .625em;
	width: 100%;
}

/* Article Meta */

.amp-wp-meta {
	color: #696969;
	display: inline-block;
	flex: 2 1 50%;
	font-size: .875em;
	line-height: 1.5em;
	margin: 0 0 1.5em;
	padding: 0;
}

.amp-wp-article-header .amp-wp-meta:last-of-type {
	text-align: right;
}

.amp-wp-article-header .amp-wp-meta:first-of-type {
	text-align: left;
}

.amp-wp-byline amp-img,
.amp-wp-byline .amp-wp-author {
	display: inline-block;
	vertical-align: middle;
}

.amp-wp-byline amp-img {
	border: 1px solid #0a89c0;
	border-radius: 50%;
	position: relative;
	margin-right: 6px;
}

.amp-wp-posted-on {
	text-align: right;
}

/* Featured image */

.amp-wp-article-featured-image {
	margin: 0 0 1em;
}
.amp-wp-article-featured-image amp-img {
	margin: 0 auto;
}
.amp-wp-article-featured-image.wp-caption .wp-caption-text {
	margin: 0 18px;
}

/* Article Content */

.amp-wp-article-content {
	margin: 0 16px;
}

.amp-wp-article-content ul,
.amp-wp-article-content ol {
	margin-left: 1em;
}

.amp-wp-article-content .wp-caption {
	max-width: 100%;
}

.amp-wp-article-content amp-img {
	margin: 0 auto;
}

.amp-wp-article-content amp-img.alignright {
	margin: 0 0 1em 16px;
}

.amp-wp-article-content amp-img.alignleft {
	margin: 0 16px 1em 0;
}

/* Captions */

.wp-caption {
	padding: 0;
}

.wp-caption.alignleft {
	margin-right: 16px;
}

.wp-caption.alignright {
	margin-left: 16px;
}

.wp-caption .wp-caption-text {
	border-bottom: 1px solid #c2c2c2;
	color: #696969;
	font-size: .875em;
	line-height: 1.5em;
	margin: 0;
	padding: .66em 10px .75em;
}

/* AMP Media */

.alignwide,
.alignfull {
	clear: both;
}

amp-carousel {
	background: #c2c2c2;
	margin: 0 -16px 1.5em;
}
amp-iframe,
amp-youtube,
amp-instagram,
amp-vine {
	background: #c2c2c2;
	margin: 0 -16px 1.5em;
}

.amp-wp-article-content amp-carousel amp-img {
	border: none;
}

amp-carousel > amp-img > img {
	object-fit: contain;
}

.amp-wp-iframe-placeholder {
	background: #c2c2c2 url( https://s2.wp.com/wp-content/plugins/amp-1.4/assets/images/placeholder-icon.png ) no-repeat center 40%;
	background-size: 48px 48px;
	min-height: 48px;
}

/* Article Footer Meta */

.amp-wp-article-footer .amp-wp-meta {
	display: block;
}

.amp-wp-tax-category,
.amp-wp-tax-tag {
	color: #696969;
	font-size: .875em;
	line-height: 1.5em;
	margin: 1.5em 16px;
}

.amp-wp-comments-link {
	color: #696969;
	font-size: .875em;
	line-height: 1.5em;
	text-align: center;
	margin: 2.25em 0 1.5em;
}

.amp-wp-comments-link a {
	border-style: solid;
	border-color: #c2c2c2;
	border-width: 1px 1px 2px;
	border-radius: 4px;
	background-color: transparent;
	color: #0a89c0;
	cursor: pointer;
	display: block;
	font-size: 14px;
	font-weight: 600;
	line-height: 18px;
	margin: 0 auto;
	max-width: 200px;
	padding: 11px 16px;
	text-decoration: none;
	width: 50%;
	-webkit-transition: background-color 0.2s ease;
			transition: background-color 0.2s ease;
}

/* AMP Footer */

.amp-wp-footer {
	border-top: 1px solid #c2c2c2;
	margin: calc(1.5em - 1px) 0 0;
}

.amp-wp-footer div {
	margin: 0 auto;
	max-width: calc(840px - 32px);
	padding: 1.25em 16px 1.25em;
	position: relative;
}

.amp-wp-footer h2 {
	font-size: 1em;
	line-height: 1.375em;
	margin: 0 0 .5em;
}

.amp-wp-footer p {
	color: #696969;
	font-size: .8em;
	line-height: 1.5em;
	margin: 0 85px 0 0;
}

.amp-wp-footer a {
	text-decoration: none;
}

.back-to-top {
	bottom: 1.275em;
	font-size: .8em;
	font-weight: 600;
	line-height: 2em;
	position: absolute;
	right: 16px;
}
		/**
 * Jetpack related posts
 */

/**
 * The Gutenberg block
 */

.jp-related-posts-i2__row {
	display: flex;
	margin-top: 1.5rem;
}

.jp-related-posts-i2__row:first-child {
	margin-top: 0;
}

.jp-related-posts-i2__post {
	flex-grow: 1;
	flex-basis: 0;
	margin: 0 10px;
	display: flex;
	flex-direction: column;
	padding-left: 0;
}

.jp-related-posts-i2__row[data-post-count="3"] .jp-related-posts-i2__post {
	max-width: calc(33% - 20px);
}

.jp-related-posts-i2__row[data-post-count="2"] .jp-related-posts-i2__post,
.jp-related-posts-i2__row[data-post-count="1"] .jp-related-posts-i2__post {
	max-width: calc(50% - 20px);
}

.jp-related-posts-i2__post-heading, .jp-related-posts-i2__post-img-link,
.jp-related-posts-i2__post-date, .jp-related-posts-i2__post-context {
	flex-direction: row;
	display: block;
}

.jp-related-posts-i2__post-heading {
	margin: 0.5rem 0;
	font-size: 1rem;
	line-height: 1.2em;
}

.jp-related-posts-i2__post-link {
	display: block;
	width: 100%;
	line-height: 1.2em;
}

.jp-related-posts-i2__post-img-link {
	order: -1;
}

.jp-related-posts-i2__post-img-link img {
	width: 100%;
}

/* List view */

.jp-relatedposts-i2[data-layout="list"] .jp-related-posts-i2__row{
	margin-top: 0;
	display: block;
}

.jp-relatedposts-i2[data-layout="list"] .jp-related-posts-i2__post {
	max-width: none;
	margin: 0;
}

.jp-relatedposts-i2[data-layout="list"].jp-related-posts-i2__post-img-link {
	margin-top: 1rem;
}

/* Breakpoints */
@media only screen and (max-width: 640px) {
	.jp-related-posts-i2__row {
		margin-top: 0;
		display: block;
	}
	.jp-related-posts-i2__row[data-post-count] .jp-related-posts-i2__post {
		max-width: none;
		margin: 0;
		margin-top: 1rem;
	}
	.jp-related-posts-i2__post-img-link {
		margin-top: 1rem;
	}
	.jp-related-posts-i2__post-img-link img {
		width: 350px;
	}
}

/* Container */

#jp-relatedposts {
	display: none;
	padding-top: 1em;
	margin: 1em 0;
	position: relative;
	clear: both;
}

.jp-relatedposts:after {
	content: '';
	display: block;
	clear: both;
}

/* Headline above related posts section, labeled "Related" */

#jp-relatedposts h3.jp-relatedposts-headline {
	margin: 0 0 1em 0;
	display: inline-block;
	float: left;
	font-size: 9pt;
	font-weight: bold;
	font-family: inherit;
}

#jp-relatedposts h3.jp-relatedposts-headline em:before {
	content: "";
	display: block;
	width: 100%;
	min-width: 30px;
	border-top: 1px solid #ddd;
	border-top: 1px solid rgba(0,0,0,.2);
	margin-bottom: 1em;
}

#jp-relatedposts h3.jp-relatedposts-headline em {
	font-style: normal;
	font-weight: bold;
}

/* Related posts items (wrapping items) */

#jp-relatedposts .jp-relatedposts-items {
	clear: left;
}

#jp-relatedposts .jp-relatedposts-items-visual {
	margin-right: -20px;
}

/* Related posts item */

#jp-relatedposts .jp-relatedposts-items .jp-relatedposts-post {
	float: left;
	width: 33%;
	margin: 0 0 1em; /* Needs to be same as the main outer wrapper for Related Posts */
	box-sizing: border-box;
	-moz-box-sizing: border-box;
	-webkit-box-sizing: border-box;
}

#jp-relatedposts .jp-relatedposts-items-visual .jp-relatedposts-post {
	padding-right: 20px;
	filter: alpha(opacity=80);
	-moz-opacity: .8;
	opacity: .8;
}

#jp-relatedposts .jp-relatedposts-items .jp-relatedposts-post:nth-child(3n+4),
#jp-relatedposts .jp-relatedposts-items-visual .jp-relatedposts-post:nth-child(3n+4) {
	clear: both;
}

#jp-relatedposts .jp-relatedposts-items .jp-relatedposts-post:hover .jp-relatedposts-post-title a {
	text-decoration: underline;
}

#jp-relatedposts .jp-relatedposts-items .jp-relatedposts-post:hover {
	filter: alpha(opacity=100);
	-moz-opacity: 1;
	opacity: 1;
}

/* Related posts item content */

#jp-relatedposts .jp-relatedposts-items-visual h4.jp-relatedposts-post-title,
#jp-relatedposts .jp-relatedposts-items p {
	font-size: 14px;
	line-height: 20px;
	margin: 0;
}
#jp-relatedposts .jp-relatedposts-items-visual .jp-relatedposts-post-nothumbs {
	position:relative;
}
#jp-relatedposts .jp-relatedposts-items-visual .jp-relatedposts-post-nothumbs a.jp-relatedposts-post-aoverlay {
	position:absolute;
	top:0;
	bottom:0;
	left:0;
	right:0;
	display:block;
	border-bottom: 0;
}

#jp-relatedposts .jp-relatedposts-items p {
	margin-bottom: 0;
}

#jp-relatedposts .jp-relatedposts-items-visual h4.jp-relatedposts-post-title {
	text-transform: none;
	margin: 0;
	font-family: inherit;
	display: block;
	max-width: 100%;
}

#jp-relatedposts .jp-relatedposts-items .jp-relatedposts-post .jp-relatedposts-post-title a {
	font-size: inherit;
	font-weight: normal;
	text-decoration: none;
	filter: alpha(opacity=100);
	-moz-opacity: 1;
	opacity: 1;
}

#jp-relatedposts .jp-relatedposts-items .jp-relatedposts-post .jp-relatedposts-post-title a:hover {
	text-decoration: underline;
}

#jp-relatedposts .jp-relatedposts-items .jp-relatedposts-post img.jp-relatedposts-post-img,
#jp-relatedposts .jp-relatedposts-items .jp-relatedposts-post span {
	display: block;
	max-width: 90%;
	overflow: hidden;
	text-overflow: ellipsis;
}

#jp-relatedposts .jp-relatedposts-items-visual .jp-relatedposts-post img.jp-relatedposts-post-img,
#jp-relatedposts .jp-relatedposts-items-visual .jp-relatedposts-post span {
	max-width: 100%;
}

#jp-relatedposts .jp-relatedposts-items .jp-relatedposts-post .jp-relatedposts-post-date,
#jp-relatedposts .jp-relatedposts-items .jp-relatedposts-post .jp-relatedposts-post-context {
	opacity: .6;
}

/* Hide the date by default, but leave the element there if a theme wants to use css to make it visible. */
.jp-relatedposts-items .jp-relatedposts-post .jp-relatedposts-post-date {
	display: none;
}

/* Behavior when there are thumbnails in visual mode */
#jp-relatedposts .jp-relatedposts-items-visual div.jp-relatedposts-post-thumbs p.jp-relatedposts-post-excerpt {
	display: none;
}

/* Behavior when there are no thumbnails in visual mode */
#jp-relatedposts .jp-relatedposts-items-visual .jp-relatedposts-post-nothumbs p.jp-relatedposts-post-excerpt {
	overflow: hidden;
}
#jp-relatedposts .jp-relatedposts-items-visual .jp-relatedposts-post-nothumbs span {
	margin-bottom: 1em;
}

/* List Layout */
#jp-relatedposts .jp-relatedposts-list .jp-relatedposts-post {
	clear: both;
	width: 100%;
}

#jp-relatedposts .jp-relatedposts-list .jp-relatedposts-post img.jp-relatedposts-post-img {
	float: left;
	overflow: hidden;
	max-width: 33%;
	margin-right: 3%;
}

#jp-relatedposts .jp-relatedposts-list h4.jp-relatedposts-post-title {
	display: inline-block;
	max-width: 63%;
}

/*
 * Responsive
 */

@media only screen and (max-width: 640px) {

	#jp-relatedposts .jp-relatedposts-items .jp-relatedposts-post {
		width: 50%;
	}

	#jp-relatedposts .jp-relatedposts-items .jp-relatedposts-post:nth-child(3n) {
		clear: left;
	}

	#jp-relatedposts .jp-relatedposts-items-visual {
		margin-right: 20px;
	}
}

@media only screen and (max-width: 320px) {

	#jp-relatedposts .jp-relatedposts-items .jp-relatedposts-post {
		width: 100%;
		clear: both;
		margin: 0 0 1em;
	}

	#jp-relatedposts .jp-relatedposts-list .jp-relatedposts-post img.jp-relatedposts-post-img,
	#jp-relatedposts .jp-relatedposts-list h4.jp-relatedposts-post-title {
		float: none;
		max-width: 100%;
		margin-right: 0;
	}
}
.wp-block-jetpack-rating-star span { display: none; }.wp-block-jetpack-rating-spiciness span, .wp-block-jetpack-rating-priciness span { display: none; }	</style>
</head>

<body class="">

<header id="top" class="amp-wp-header">
	<div>
		<a href="https://feilipu.me/">
									<span class="amp-site-title">
				feilipu			</span>
		</a>

					</div>
</header>

<article class="amp-wp-article">
	<header class="amp-wp-article-header">
		<h1 class="amp-wp-title">Three Rings for the Z80</h1>
			<div class="amp-wp-meta amp-wp-byline">
					<amp-img src="https://secure.gravatar.com/avatar/f382ee34fc130c7f0126e42a741ac5f8?s=24&#038;d=identicon&#038;r=g" alt="feilipu" width="24" height="24" layout="fixed"></amp-img>
				<span class="amp-wp-author author vcard">feilipu</span>
	</div>
<div class="amp-wp-meta amp-wp-posted-on">
	<time datetime="2018-05-28T21:13:02+00:00">
		2 years ago	</time>
</div>
	</header>

	
	<div class="amp-wp-article-content">
		<p><a href="https://feilipu.files.wordpress.com/2018/05/unico_anello.png"><amp-img class="wp-image-175402331 alignright amp-wp-enforced-sizes" src="https://feilipu.files.wordpress.com/2018/05/unico_anello.png?w=151&amp;h=131" alt="" width="151" height="131" srcset="https://feilipu.files.wordpress.com/2018/05/unico_anello.png?w=151&amp;h=131 151w, https://feilipu.files.wordpress.com/2018/05/unico_anello.png?w=302&amp;h=262 302w" layout="intrinsic"><noscript><img class=" wp-image-175402331 alignright" src="https://feilipu.files.wordpress.com/2018/05/unico_anello.png?w=151&amp;h=131" alt="" width="151" height="131" srcset="https://feilipu.files.wordpress.com/2018/05/unico_anello.png?w=151&amp;h=131,https://feilipu.files.wordpress.com/2018/05/unico_anello.png?w=302&amp;h=262" sizes="(max-width: 151px) 100vw, 151px"></noscript></amp-img></a>Over the past few years I’ve implemented a number of interfaces for Z80 peripherals based on the principal of the interrupt driven ring buffer. Each implementation of a ring exhibits its own peculiarities, based on the specific hardware. But essentially I have but one ring to bring them all and in the darkness bind them.</p>
<p>This is some background on how these interfaces work, why they’re probably fairly optimal at what they do, and things to consider if extending these to other platforms and devices.</p>
<p>The ring buffer is a mechanism which allows a producer and a consumer of information to do so with a timing to suit their needs, and to do it without coordinating their timing.</p>
<p>The Wikipedia defines a <a href="https://en.wikipedia.org/wiki/Circular_buffer" target="_blank" rel="noopener">circular buffer</a>, or ring buffer,  as a <a href="https://en.wikipedia.org/wiki/Data_structure" target="_blank" rel="noopener">data structure</a> that uses a single fixed-size <a href="https://en.wikipedia.org/wiki/Buffer_(computer_science)" target="_blank" rel="noopener">buffer</a> as if it were connected end-to-end. The most useful property of the ring buffer is that it does not need to have its elements relocated as they are added or consumed. It is best suited to be a <a href="https://en.wikipedia.org/wiki/FIFO_(computing_and_electronics)" target="_blank" rel="noopener">FIFO</a> buffer.</p>
<h2>Background</h2>
<p>Over the past few years, I’ve used the ring buffer mechanism written by <a href="https://github.com/feilipu/avrfreertos/blob/master/freeRTOS10xx/include/ringBuffer.h" target="_blank" rel="noopener">Dean Camera</a> in many <a href="https://github.com/feilipu/avrfreertos/blob/master/freeRTOS10xx/lib_io/serial.c#L1174" target="_blank" rel="noopener">AVR projects</a>. These include interrupt driven <a href="https://github.com/feilipu/avrfreertos/blob/master/freeRTOS10xx/lib_io/serial.c#L1174" target="_blank" rel="noopener">USART interfaces</a>, a digital <a href="https://github.com/feilipu/avrfreertos/blob/master/GA_Synth/main.c#L668" target="_blank" rel="noopener">audio delay</a> loop, and a <a href="https://github.com/feilipu/avrfreertos/blob/master/GA_WalkieTalkie/main.c#L290" target="_blank" rel="noopener">packet assembly and play-out</a> buffer for a digital walkie-talkie.</p>
<p>More recently, I’ve been working with Z80 platforms and I’ve taken that experience into building interrupt driven ring buffer mechanisms for peripherals on the Z80 bus. These include three rings for three different USART implementations, and a fourth ring for an Am9511A APU.</p>
<p><a href="https://feilipu.files.wordpress.com/2018/05/circular_buffer_animation.gif"><amp-anim class="size-medium wp-image-175402332 alignright amp-wp-enforced-sizes" src="https://feilipu.files.wordpress.com/2018/05/circular_buffer_animation.gif?w=300&amp;h=225" alt="" width="300" height="225" layout="intrinsic"><noscript><img class="size-medium wp-image-175402332 alignright" src="https://feilipu.files.wordpress.com/2018/05/circular_buffer_animation.gif?w=300&amp;h=225" alt="" width="300" height="225"></noscript></amp-anim></a>But firstly, how does the ring buffer work? For the details, the Wikipedia entry on <a href="https://en.wikipedia.org/wiki/Circular_buffer" target="_blank" rel="noopener">circular buffers</a> is the best bet. But quickly, the information (usually a byte, but not necessarily) is pushed into the buffer by the producer, and it is removed by the consumer.</p>
<p>The producer maintains a pointer to where it is inserting the data. The consumer maintains a pointer to where it is removing the data. Both producer and consumer have access to a count of how many items there are in the buffer and, critically, the act of counting entries present in the buffer and adding or removing data must be synchronised or <a href="https://en.wikipedia.org/wiki/Linearizability" target="_blank" rel="noopener">atomic</a>.</p>
<h2>8 Bit Optimisation</h2>
<p>The AVR example code is written in C and is not optimised for the Z80 platform. By using some platform specific design decisions it is possible to substantially optimise the operation of a general ring buffer, which is important as the Z80 is fairly slow.</p>
<p>The first optimisation is to assume that the buffer is exactly one page or 256 bytes. The advantage we have there is that addressing in Z80 is 16 bits and if we’re only using the lowest 8 bits of addressing to address 256 bytes, then we simply need to align the buffer onto a single 256 byte page and then <a href="https://github.com/z88dk/z88dk/blob/master/libsrc/_DEVELOPMENT/target/rc2014/device/acia/acia_interrupt.asm#L34" target="_blank" rel="noopener">increment through the lowest byte</a> of the buffer address to manage the pointer access.</p>
<p>If 256 bytes is too many to allocate to the buffer, then if we use a power of 2 buffer size, and then align the buffer within the memory so that it falls on the boundary of the buffer size, the calculation for the pointers becomes <a href="https://github.com/z88dk/z88dk/blob/master/libsrc/_DEVELOPMENT/target/rc2014/device/acia/acia_interrupt.asm#L58" target="_blank" rel="noopener">simple masking</a> (rather than a decision and jump). Simple masking ensures that no jumps are taken, which means that the code flow or delay is constant no matter which place in the buffer is been written or read.</p>
<p>Note that although the number of bytes allocated to the buffer is 256, the buffer cannot be filled completely. A completely full 256 byte buffer cannot be discriminated from a zero fullness buffer. This does not apply where the buffer is smaller than the full page.</p>
<p>With these two optimisations in place, we can now look at three implementations of USART interfaces for the Z80 platform. These are the <a href="http://www.cpcwiki.eu/imgs/3/3f/MC6850.pdf" target="_blank" rel="noopener">MC6580 ACIA</a> , the <a href="http://www.z80.info/zip/um0081.pdf" target="_blank" rel="noopener">Zilog SIO/2</a>, and the <a href="https://www-users.cs.york.ac.uk/~pcc/Circuits/64180/docs/z180faq.pdf" target="_blank" rel="noopener">Z180 ASCI</a> interface. There is also the <a href="http://www.cpushack.com/2010/09/23/arithmetic-processors-then-and-now/" target="_blank" rel="noopener">Am9511A</a> interface, which is a little special as it has multiple independent ring buffers, and has multi-byte insertion.</p>
<h2>Implementations</h2>
<p>To start the discussion, let us look at the ACIA implementation for the <a href="https://github.com/RC2014Z80/RC2014/blob/master/ROMs/CPM-IDE/acia/cpm22bios.asm" target="_blank" rel="noopener">RC2014 CP/M-IDE</a> bios. I have chosen this file because all of the functions are contained in one file, which provides an easier overview. The functions are identical to those found in the <a href="https://github.com/z88dk/z88dk/tree/master/libsrc/_DEVELOPMENT/target/rc2014/device/acia" target="_blank" rel="noopener">z88dk RC2014 ACIA</a> device directory.</p>
<p>Using the ALIGN key word of the z88dk, the ring buffer itself is placed on a <a href="https://github.com/RC2014Z80/RC2014/blob/master/ROMs/CPM-IDE/acia/cpm22bios.asm#L1550" target="_blank" rel="noopener">page boundary</a>, in the case of the receive buffer of 256 bytes, and on the <a href="https://github.com/RC2014Z80/RC2014/blob/master/ROMs/CPM-IDE/acia/cpm22bios.asm#L1543" target="_blank" rel="noopener">buffer size boundary</a>, in the case of the transmit buffer of 2^n bytes.</p>
<p>Note that although where the buffer is smaller than a full page all of the bytes in the buffer could be used, because the buffer counter won’t overflow, but I haven’t made that additional optimisation in my code. So no matter how many bytes are allocated to a buffer, one byte always remains unused.</p>
<p>Once the buffer is located, the process of producing and consuming data is left to either <a href="https://github.com/RC2014Z80/RC2014/blob/master/ROMs/CPM-IDE/acia/cpm22bios.asm#L981" target="_blank" rel="noopener">put</a> or <a href="https://github.com/RC2014Z80/RC2014/blob/master/ROMs/CPM-IDE/acia/cpm22bios.asm#L920" target="_blank" rel="noopener">get</a> functions which write to, or read from the buffer as and when they choose to. There is no compulsion for the main program flow to write or read at a particular time, and therefore the flow of code is never delayed. This is optimum from the point of view of minimising delay and maximising compute time. Additional functions such as <a href="https://github.com/RC2014Z80/RC2014/blob/master/ROMs/CPM-IDE/acia/cpm22bios.asm#L898" target="_blank" rel="noopener">flush</a>, <a href="https://github.com/RC2014Z80/RC2014/blob/master/ROMs/CPM-IDE/acia/cpm22bios.asm#L956" target="_blank" rel="noopener">peek</a>, and <a href="https://github.com/RC2014Z80/RC2014/blob/master/ROMs/CPM-IDE/acia/cpm22bios.asm#L967" target="_blank" rel="noopener">poll</a> are also provided to simplify program flow, and <a href="https://github.com/RC2014Z80/RC2014/blob/master/ROMs/CPM-IDE/acia/cpm22bios.asm#L859" target="_blank" rel="noopener">init</a> to set up the peripheral and initialise the buffers on first use.</p>
<p>With the buffer available then the <a href="https://github.com/RC2014Z80/RC2014/blob/master/ROMs/CPM-IDE/acia/cpm22bios.asm#L785" target="_blank" rel="noopener">interrupt</a> function can do its work. Once an interrupt from the peripheral is signalled, the interrupt code checks to see whether a byte has been received. If not then the interrupt (in the case of the ACIA and ASCI) must have been triggered by the transmit hardware becoming available.</p>
<p>If in fact a byte has been received by the peripheral then the interrupt code recovers the byte, and checks there is room in the buffer to store it. If not, then the byte is simply abandoned. If there is space, then the byte is stored, and the buffer count is incremented. It is critical that these two items happen atomically, which in the case of an interrupt is the natural situation.</p>
<p>If the transmission hardware has signalled that it is free, then the buffer is checked for an available byte to transmit. If none is found then the transmit interrupt is disabled. Otherwise the byte is retrieved from the buffer and written to the transmit hardware while the buffer count is decremented.</p>
<p>If the transmit buffer count reaches zero when the current byte is transmitted, then the interrupt must disable further transmit interrupts to prevent the interrupt being called unnecessarily (i.e. with the buffer fullness being empty).</p>
<h3>Multi-byte Receive</h3>
<p>Both the SIO and ASCI have multi-byte hardware FIFO buffers available. This is to prevent over-run of the hardware should the CPU be unable to service the receive interrupt in sufficient time. This could happen if the CPU is left with its general interrupt disabled for some time.</p>
<p>In this situation, the <a href="https://github.com/RC2014Z80/RC2014/blob/master/ROMs/CPM-IDE/sio/cpm22bios.asm#L844" target="_blank" rel="noopener">SIO receive interrupt</a> and the <a href="https://github.com/feilipu/yaz180/blob/master/yabios/asm_common1_driver.asm#L1339" target="_blank" rel="noopener">ASCI interrupt</a> have the capability to check for additional bytes before continuing.</p>
<h3>Transmit cut-through</h3>
<p>One additional feature worth discussing is the presence of a transmit cut-through, which minimises delay when writing the “first byte”. Because the Z80 processor is relatively slow compared to a serial interface, it is common for the transmit interface to be idle when the first byte of a sequence of bytes is written. In this situation writing the byte into the transmit buffer, and then signalling a pseudo interrupt (by calling the interrupt routine) would be very costly. In the case of the first byte it is much more effective simply to cut-through and <a href="https://github.com/RC2014Z80/RC2014/blob/master/ROMs/CPM-IDE/sio/cpm22bios.asm#L1187" target="_blank" rel="noopener">write directly</a> to the hardware.</p>
<h3>Atomicity</h3>
<p>For the ring buffer to function effectively, the <a href="https://en.wikipedia.org/wiki/Linearizability" target="_blank" rel="noopener">atomicity</a> of specific operations must be guaranteed. During an interrupt in Z80 further interrupts are typically not permitted, so within the interrupt we have a degree of atomicity. The only exception to this rule is the Z80 Non Maskable Interrupt (<a href="http://www.z80.info/zip/z80-interrupts_rewritten.pdf" target="_blank" rel="noopener">NMI</a>), but since this interrupt is not compatible with CP/M it has never been used widely and is therefore not a real issue.</p>
<p>For the buffer get function the only concern is that the <a href="https://github.com/RC2014Z80/RC2014/blob/master/ROMs/CPM-IDE/acia/cpm22bios.asm#L934" target="_blank" rel="noopener">retrieval of a byte is atomically linked to the number of bytes</a> in the buffer.</p>
<p>For the put function it is similar, however as the <a href="https://github.com/RC2014Z80/RC2014/blob/master/ROMs/CPM-IDE/acia/cpm22bios.asm#L1023" target="_blank" rel="noopener">transmit interrupt needs to be enabled</a> by the put function atomcity is required to ensure that this process is not interrupted.</p>
<h3>Interrupt Mode</h3>
<p>Across the three implementations there are three different Z80 interrupt modes in play. The Motorola ACIA is not a Zilog Z80 peripheral, so it can only signal a normal interrupt, and can therefore (without some dirty tricks) only work in Interrupt Mode 1. For the RC2014 implementation it is <a href="https://github.com/RC2014Z80/RC2014/blob/master/ROMs/CPM-IDE/acia/cpm22bios.asm#L151" target="_blank" rel="noopener">attached to INT or RST38</a> and therefore when an interrupt is triggered it is up to the interrupt routine to determine why an interrupt has been raised. This leads to a fairly long and slow interrupt code.</p>
<p>The Z180 ASCI has two ports and is attached to the Z180 internal interrupt structure, which works effectively similarly to the Z80 Interrupt Mode 2, although it is actually independent from the Z80 interrupt mode. Each <a href="https://github.com/feilipu/yaz180/blob/master/yabios/asm_common1_driver.asm#L1305" target="_blank" rel="noopener">Z180 internal interrupt</a> is separately triggered, however it still cannot discern between a receive and a transmit event. So the interrupt handling is essentially similar to that of the ACIA.</p>
<p>The Zilog SIO/2 is capable of being attached to the Z80 in Interrupt Mode 2. This means that the <a href="https://github.com/RC2014Z80/RC2014/blob/master/ROMs/CPM-IDE/sio/sio_init_async_rodata.asm#L25" target="_blank" rel="noopener">SIO is capable of being configured</a> to load the Z80 address lines during an interrupt with a specific vector for each interrupt cause. The interrupts for <a href="https://github.com/RC2014Z80/RC2014/blob/master/ROMs/CPM-IDE/sio/cpm22bios.asm#L772" target="_blank" rel="noopener">transmit empty</a>, <a href="https://github.com/RC2014Z80/RC2014/blob/master/ROMs/CPM-IDE/sio/cpm22bios.asm#L807" target="_blank" rel="noopener">received byte</a>, transmit error, and receive error are all signalled separately via an <a href="https://github.com/RC2014Z80/RC2014/blob/master/ROMs/CPM-IDE/sio/cpm22bios.asm#L1625" target="_blank" rel="noopener">IM2 Interrupt Vector Table</a>. This leads to concise and fast interrupts, specific to the cause at hand. The SIO/2 is the most efficient of all the interfaces described here.</p>
<h3>Multi-byte buffers</h3>
<p>For interest, the <a href="https://github.com/z88dk/z88dk/tree/master/libsrc/_DEVELOPMENT/target/yaz180/device/am9511a" target="_blank" rel="noopener">Am9511A interface</a> uses <a href="https://github.com/z88dk/z88dk/blob/master/libsrc/_DEVELOPMENT/target/yaz180/device/am9511a/__am9511a_data.asm" target="_blank" rel="noopener">two buffers</a>, one for the one byte commands, and one for the two byte operand pointers. The command buffer is loaded with actions that the APU needs to perform, including some special (non hardware) commands to support <a href="https://github.com/z88dk/z88dk/blob/master/libsrc/_DEVELOPMENT/target/yaz180/device/am9511a/am9511a_isr.asm#L59" target="_blank" rel="noopener">loading</a> and <a href="https://github.com/z88dk/z88dk/blob/master/libsrc/_DEVELOPMENT/target/yaz180/device/am9511a/am9511a_isr.asm#L122" target="_blank" rel="noopener">unloading operands</a> from the APU FILO.</p>
<p>A second Am9511A interface also uses two buffers, one for one byte commands, and one for either <a href="https://github.com/feilipu/yaz180/blob/master/yabios/asm_common1_driver.asm#L976" target="_blank" rel="noopener">two</a> or <a href="https://github.com/feilipu/yaz180/blob/master/yabios/asm_common1_driver.asm#L987" target="_blank" rel="noopener">four</a> byte operands. This mechanism in not as nice as storing pointers as in the above driver, but is required for situations where the Z180 is operating with paged memory.</p>
<p>I’ve revised this above solution again and do it with three <a href="https://github.com/z88dk/z88dk/commit/74093a424239e56a84b54ed827ef836497c0ae71" target="_blank" rel="noopener">byte operand (far) pointers</a>, as that makes for a much simplified user experience. The operands don’t have to be unloaded by the user. They simply appear auto-magically…</p>
<div id="jp-post-flair" class="sharedaddy"><div class="sharedaddy sd-sharing-enabled"><div class="robots-nocontent sd-block sd-social sd-social-icon-text sd-sharing"><h3 class="sd-title">Share this:</h3><div class="sd-content"><amp-social-share type="twitter"></amp-social-share><amp-social-share type="facebook" data-param-app_id="249643311490"></amp-social-share></div></div></div>
<nav class="jp-relatedposts-i2" data-layout="grid"><h3 class="jp-relatedposts-headline"><em>Related</em></h3><div class="jp-related-posts-i2__row" data-post-count="3"><ul id="related-posts-item-5eaaa414829c9" aria-labelledby="related-posts-item-5eaaa414829c9-label" class="jp-related-posts-i2__post" role="menuitem"><li class="jp-related-posts-i2__post-link"><a id="related-posts-item-5eaaa414829c9-label" href="https://feilipu.me/2017/02/26/yet-another-z180-v2/">Yet Another Z180 (YAZ180 v2)</a></li><li class="jp-related-posts-i2__post-img-link"><a href="https://feilipu.me/2017/02/26/yet-another-z180-v2/"><amp-img src="https://feilipu.files.wordpress.com/2017/02/p1080759.jpg?w=350&amp;h=200&amp;crop=1" width="350" alt="" height="200" class="amp-wp-enforced-sizes" layout="intrinsic"><noscript><img src="https://feilipu.files.wordpress.com/2017/02/p1080759.jpg?w=350&amp;h=200&amp;crop=1" width="350" alt="" height="200" class=""></noscript></amp-img></a></li><li class="jp-related-posts-i2__post-date">February 26, 2017</li><li class="jp-related-posts-i2__post-context">In "am9511a"</li></ul><ul id="related-posts-item-5eaaa414829fe" aria-labelledby="related-posts-item-5eaaa414829fe-label" class="jp-related-posts-i2__post" role="menuitem"><li class="jp-related-posts-i2__post-link"><a id="related-posts-item-5eaaa414829fe-label" href="https://feilipu.me/2016/05/23/another-z80-project/">Yet Another Z180 Project (YAZ180)</a></li><li class="jp-related-posts-i2__post-img-link"><a href="https://feilipu.me/2016/05/23/another-z80-project/"><amp-img src="https://feilipu.files.wordpress.com/2017/02/img_0620.jpg?w=350&amp;h=200&amp;crop=1" width="350" alt="" height="200" class="amp-wp-enforced-sizes" layout="intrinsic"><noscript><img src="https://feilipu.files.wordpress.com/2017/02/img_0620.jpg?w=350&amp;h=200&amp;crop=1" width="350" alt="" height="200" class=""></noscript></amp-img></a></li><li class="jp-related-posts-i2__post-date">May 23, 2016</li><li class="jp-related-posts-i2__post-context">In "8008"</li></ul><ul id="related-posts-item-5eaaa41482a14" aria-labelledby="related-posts-item-5eaaa41482a14-label" class="jp-related-posts-i2__post" role="menuitem"><li class="jp-related-posts-i2__post-link"><a id="related-posts-item-5eaaa41482a14-label" href="https://feilipu.me/2017/02/22/characterising-am9511a-1-apu/">Characterising Am9511A-1 APU</a></li><li class="jp-related-posts-i2__post-img-link"><a href="https://feilipu.me/2017/02/22/characterising-am9511a-1-apu/"><amp-img src="https://feilipu.files.wordpress.com/2017/02/am9511a-1-tray.jpg?w=350&amp;h=200&amp;crop=1" width="350" alt="" height="200" class="amp-wp-enforced-sizes" layout="intrinsic"><noscript><img src="https://feilipu.files.wordpress.com/2017/02/am9511a-1-tray.jpg?w=350&amp;h=200&amp;crop=1" width="350" alt="" height="200" class=""></noscript></amp-img></a></li><li class="jp-related-posts-i2__post-date">February 22, 2017</li><li class="jp-related-posts-i2__post-context">In "am9511a"</li></ul></div></nav></div>	</div>

	<footer class="amp-wp-article-footer">
			<div class="amp-wp-meta amp-wp-tax-category">
		Categories: <a href="https://feilipu.me/category/uncategorized/" rel="category tag">Uncategorized</a>	</div>

	<div class="amp-wp-meta amp-wp-tax-tag">
		Tags: <a href="https://feilipu.me/tag/am9/" rel="tag">Am9</a>, <a href="https://feilipu.me/tag/am9511a/" rel="tag">am9511a</a>, <a href="https://feilipu.me/tag/assembly/" rel="tag">assembly</a>, <a href="https://feilipu.me/tag/interfaces/" rel="tag">interfaces</a>, <a href="https://feilipu.me/tag/ring-buffer/" rel="tag">ring buffer</a>, <a href="https://feilipu.me/tag/serial/" rel="tag">serial</a>, <a href="https://feilipu.me/tag/uart/" rel="tag">uart</a>, <a href="https://feilipu.me/tag/usart/" rel="tag">usart</a>, <a href="https://feilipu.me/tag/z180/" rel="tag">Z180</a>, <a href="https://feilipu.me/tag/z80/" rel="tag">Z80</a>, <a href="https://feilipu.me/tag/z88dk/" rel="tag">z88dk</a>, <a href="https://feilipu.me/tag/zilog/" rel="tag">zilog</a>	</div>
		<div class="amp-wp-meta amp-wp-comments-link">
		<a href="..\index.html#comments">
			Leave a Comment		</a>
	</div>
	</footer>
</article>

<footer class="amp-wp-footer">
	<div>
		<h2>feilipu</h2>
		<a href="#top" class="back-to-top">Back to top</a>
	</div>
</footer>


	<amp-pixel src="https://pixel.wp.com/b.gif?rand=RANDOM&#038;host=feilipu.me&#038;ref=DOCUMENT_REFERRER&#038;amp=1&#038;blog=47691308&#038;v=wpcom&#038;tz=10&#038;user_id=0&#038;post=175402327&#038;subd=feilipu"></amp-pixel>
	<amp-pixel src="https://pixel.wp.com/b.gif?rand=RANDOM&#038;v=wpcom-no-pv&#038;crypt=UE40eW5QN0p8M2Y%2FRE1TaVhzUzFMbjdWNHpwZGhTayxPSUFCMGNrd29%2BSmw0TDhnZmRTK0hlRi9QSGh6bi9GXVhBJWIlZlR5U1JMLU8%2FMkNtblkvY1dzSWJCdm5%2Ba3NQcGsleVV5VXlydU1KL2gvLFhfenhmODA9eCs%2FaTR3Li45YXF5RXx3VS5pLHMrRE1nUHp5ZTNfeXJMMH53czkmTzZiOG1XMUxwVU43XXJYJUYrS1NfY3UmS1Z1XWtEXUUtK11sNzh3WG9RMzRfUltMNVVfaVM9NThsa2VbOThzU35%2BSUNbeXBFanA3TC82M2dZYzdJOHNR"></amp-pixel>
	
</body>
</html>
